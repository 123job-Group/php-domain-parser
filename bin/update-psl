#!/usr/bin/env php
<?php

use Pdp\PublicSuffixListManager;
use Pdp\Http\CurlHttpAdapter;
use Pdp\Tests\Cache\FileCacheAdapter;

function getVendorPath()
{
    if (is_dir($vendor = __DIR__.'/../vendor')) {
        return $vendor;
    }

    if (is_dir($vendor = __DIR__.'/../../../../vendor')) {
        return $vendor;
    }

    return null;
}

if (($vendorPath = getVendorPath()) === null) {
    echo 'You must set up the project dependencies, run the following commands:'.PHP_EOL.
        'curl -s http://getcomposer.org/installer | php'.PHP_EOL.
        'php composer.phar install'.PHP_EOL;
    exit(1);
}

require $vendorPath.'/autoload.php';

$cacheDir = ($argc == 2 && is_dir($argv[1])) ? $argv[1] : '';

try {
    echo 'Updating Public Suffix List.' . PHP_EOL;
    /**
     * @TODO: Having the adapter baked in with no way for the library user to provide
     * their own is problematic. Fix it or leave it? No one has ever complained.
     */
    $manager = new PublicSuffixListManager(new FileCacheAdapter($cacheDir), new CurlHttpAdapter());
    $manager->refreshPublicSuffixList();
    echo 'Update complete.' . PHP_EOL;
    exit(0);
} catch (Exception $e) {
    echo 'An error occurred while updating the Public Suffix List.' . PHP_EOL;
    echo $e->getMessage() . PHP_EOL;
    exit(1);
}
